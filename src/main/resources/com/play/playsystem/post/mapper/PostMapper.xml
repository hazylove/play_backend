<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.play.playsystem.post.mapper.PostMapper">
    <select id="count" resultType="java.lang.Long">
        select count(id) from t_post p
        <include refid="query"/>
    </select>
    <select id="getPostList" resultMap="postMap">
        select
            p.id,
            p.post_title,
            p.post_content,
            p.post_created_date,
            (select count(c.id) from t_comment c where c.comment_post_id = p.id) as comment_count
        from t_post p
        <include refid="query"/>
        <include refid="orderSql"/>
        limit #{page},#{pageSize}
    </select>
    <select id="selectById" resultMap="postMap">
        select
            p.id,
            p.post_title,
            p.post_content,
            p.post_created_date,
            (select count(c.id) from t_comment c where c.comment_post_id = p.id) as answer_count
        from t_post p
        where p.id = #{id}
    </select>
    <sql id="query">
        <where>
            <if test="keywords != null and keywords !=''">
                and (p.title like concat('%',#{keywords},'%') or p.content like concat('%',#{keywords},'%'))
            </if>
        </where>
    </sql>
    <sql id="orderSql">
        <choose>
            <when test="(sortField == 'post_created_date' or sortField == 'post_title') and (sortOrder.toLowerCase() == 'asc' or sortOrder.toLowerCase() == 'desc')">
                <![CDATA[ORDER BY ${sortField} ${sortOrder}]]>
            </when>
            <otherwise>
                ORDER BY post_created_date DESC
            </otherwise>
        </choose>
    </sql>
    <resultMap id="postMap" type="com.play.playsystem.post.domain.entity.Post">
        <id property="id" column="id"/>
        <result property="postTitle" column="post_title"/>
        <result property="postContent" column="post_content"/>
        <result property="postTag" column="post_tag"/>
        <result property="postCreatedId" column="post_created_id"/>
        <result property="postCreatedDate" column="post_created_date"/>
        <result property="postCommentNum" column="comment_count"/>
        <association property="postCreatedBy" javaType="com.play.playsystem.user.domain.entity.User" column="post_created_id" select="com.play.playsystem.user.mapper.UserMapper.getUserInfoById">
            <id property="id" column="comment_created_id"/>
        </association>
    </resultMap>

</mapper>